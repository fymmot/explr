var api=api||{};api.lastfm={},api.lastfm.key="865b1653dbe200905a5b75d9d839467a",api.lastfm.url="http://ws.audioscrobbler.com/2.0/",api.lastfm.send=function(t,e,a){var n,i,r=api.lastfm.url+"?method="+t+"&api_key="+api.lastfm.key+"&format=json";return e.forEach(function(t){r+="&"+t[0]+"="+(t[1]+"").replace("&","%26").replace("/","%2F").replace("+","%2B").replace("\\","%5C")}),n=d3.json(r,function(t,e){i=!0,a(t,e)}),setTimeout(function(){i||(n.abort(),a("ERROR",{error:"Took to long to respond"}))},2e4),n};var api=api||{},superCount=0;!function(t,e){d3.csv("assets/data/countries.csv",function(e,a){alias=d3.nest().key(function(t){return t.tag.toLowerCase()}).map(a),cname=d3.nest().key(function(t){return t.name.toLowerCase()}).map(a),api.getCountry=function(t,e){api.lastfm.send("artist.gettoptags",[["artist",t]],function(a,n){var i=!0;return!a&&n.toptags&&n.toptags.tag&&n.toptags.tag.length?(n.toptags.tag.forEach(function(a,n){if(i){var r,o=a.name.toLowerCase();try{cname[o]&&cname[o][0].id?(r=cname[o][0].id,countryName=cname[o][0].name):alias[o]&&alias[o][0].id&&(r=alias[o][0].id,countryName=alias[o][0].name),r&&(e({artist:t,id:r,tag:a.name,name:countryName}),i=!1)}catch(s){}}}),void(i&&e({artist:t}))):void e({artist:t})})},api.getCountries=function(e,a){var n=[],i=0,r=function(){i++,superCount++,d3.select("#loading-text").html("Loading artists...<br>("+superCount+"/"+SESSION.total_artists+")<br>Feel free to start<br>exploring!"),i===e.length&&(t.localStorage.artists=JSON.stringify(STORED_ARTISTS),a(n))};e.forEach(function(t,e){if(STORED_ARTISTS[t]&&STORED_ARTISTS[t].country){var a=STORED_ARTISTS[t].country;a.artist=t,n.push(a),r()}else{(new Date).getTime();api.getCountry(t,function(e){STORED_ARTISTS[t]=STORED_ARTISTS[t]||{},STORED_ARTISTS[t].country={id:e.id,name:e.name},n.push(e),r()})}})}}),api.getTags=function(e,a){STORED_ARTISTS[e]&&STORED_ARTISTS[e].tags?a(STORED_ARTISTS[e].tags):(STORED_ARTISTS[e]=STORED_ARTISTS[e]||{},STORED_ARTISTS[e].tags=[],api.lastfm.send("artist.gettoptags",[["artist",e]],function(n,i){STORED_ARTISTS[e].tags=i.toptags.tag,t.localStorage.artists=JSON.stringify(STORED_ARTISTS),a(STORED_ARTISTS[e].tags)}))},api.getArtistInfo=function(t,e){var a=[];api.lastfm.send("artist.getinfo",[["artist",t]],function(n,i){var r=[];i.artist.tags.tag&&i.artist.tags.tag.forEach(function(t,e){r.push(t.name)}),a.push({name:t,url:i.artist.url,image:i.artist.image[3]["#text"],description:i.artist.bio.summary,tags:r}),e(a)})};var a=[],n=function(){a.forEach(function(t){t.abort()}),a=[]};api.getRecommendations=function(t,e){n();var i=[],r=USER_TAGS.slice(0,15),o=d3.nest().key(function(t){return t.tag}).rollup(function(t){return t[0].count}).map(r),s=api.lastfm.send("tag.gettopartists",[["tag",t],["limit",100]],function(n,r){var s={};if(n||r.error||!r.topartists||!r.topartists.artist)return void e([]);var l=r.topartists.artist;l.forEach(function(n,r){s[n.name]=[];var c=api.lastfm.send("artist.gettoptags",[["artist",n.name]],function(a,c){var d=!c.error&&(c.toptags.tag?!0:!1);if(d3.select("#rec-loading-current").html("("+n.name+")"),d){var u=d3.nest().key(function(t){return t.name}).map(c.toptags.tag);if(u[t])for(var g=c.toptags.tag.length-1;g>=0;g--)o[c.toptags.tag[g].name]&&c.toptags.tag[g].count>5&&s[n.name].push(c.toptags.tag[g].name)}r===l.length-1&&(d3.keys(s).forEach(function(t){i.push({name:t,count:s[t].length,tags:s[t]})}),i.sort(function(t,e){return e.count<t.count?-1:e.count>t.count?1:0}),e(i))});a.push(c)})});a.push(s)},api.getFriends=function(t){api.lastfm.send("user.getFriends",[["user",SESSION.name]],t)}}(window,document);var STORED_ARTISTS=JSON.parse(window.localStorage.artists||"{}"),USER_TAGS=[],CACHED_USERS=JSON.parse(window.localStorage.cached_users||"{}"),SESSION={};!function(){var t,e,a=1,n={},r=0,o=["Malawi","Malaysia","Peru","Sierra Leone","Trinidad & Tobago","Greece","Laos","Iran","Haiti","Nicaragua","Mongolia","Slovakia"],s=function(){api.lastfm.send("library.getartists",[["user",t],["limit",50],["page",a]],function(i,o){if(""===o)return console.error('Got empty string ("") as response, skipping page.'),a++,void s();if(i||o.error)if(console.error("Error in getAllArtists, page "+a,i,o),r++<5)s();else{var l=confirm("Last.fm took too long to respond.\n\nPress OK to refresh the page and try again, or Cancel to use the page as it is.");l&&(window.localStorage.clear(),window.localStorage.artists=JSON.stringify(STORED_ARTISTS),window.location.reload())}else{r=0,1===a&&(SESSION.total_artists=+o.artists["@attr"].total,e=+o.artists["@attr"].totalPages),a++;var c=[];o.artists.artist.forEach(function(t){var e=STORED_ARTISTS[t.name]||{};e.playcount=+t.playcount,e.url=t.url,e.image=[t.image[3]],STORED_ARTISTS[t.name]=e,c.push(t.name)}),window.localStorage.artists=JSON.stringify(STORED_ARTISTS),api.getCountries(c,function(i){var r=d3.nest().key(function(t){return t.id}).rollup(function(t){return t}).map(i);return d3.keys(r).forEach(function(e){n[e]=n[e]||{},n[e][t]=n[e][t]||[];var a=n[e][t];a=a.concat(r[e]),a.forEach(function(t,e){a[e].image=STORED_ARTISTS[t.artist].image[0]["#text"],a[e].url=STORED_ARTISTS[t.artist].url,a[e].playcount=STORED_ARTISTS[t.artist].playcount}),n[e][t]=a}),map.putCountryCount(n),a>e?void d():void s()})}})},l=function(t,e){var a=0,n={},r=e.topartists.artist,o=function(){USER_TAGS=[],forbidden=["american","swedish","british","female vocalists","male vocalists","german"],d3.keys(n).forEach(function(t){var e=!1;for(i=0;i<forbidden.length;i++)t===forbidden[i]&&(e=!0);e||USER_TAGS.push({tag:t,count:n[t]})}),USER_TAGS.sort(function(t,e){return e.count<t.count?-1:e.count>t.count?1:0}),console.log("Done getting tags, saved to localStorage.user_tags"),window.localStorage.user_tags=JSON.stringify(USER_TAGS)};r.forEach(function(t,e){setTimeout(function(){api.lastfm.send("artist.gettoptags",[["artist",t.name]],function(t,e){if(taglist=e.toptags.tag,taglist)for(var i=Math.min(taglist.length,10),s=0;i>s;s++)n[taglist[s].name]?n[taglist[s].name]++:n[taglist[s].name]=1;a++,a==r.length-1&&o()})},3e3*Math.random())})},c=function(){ga("send","event","splash screen","Go!","test");var e=d3.select("#welcome-container");if(e.transition().duration(2e3).style("opacity",0).each("end",function(){e.remove()}),d3.select(".loader").transition().duration(2e3).style("opacity",1),d3.select("#loading-text").html("Getting library..."),setTimeout(function(){"Getting library..."===d3.select("#loading-text").html()&&(d3.select("#loading-text").html("Last.fm is taking<br>a long time to<br>respond..."),setTimeout(function(){"Last.fm is taking<br>a long time to<br>respond..."===d3.select("#loading-text").html()&&d3.select("#loading-text").html("Maybe <a href='http://last.fm' target='_blank'>last.fm</a> has<br>gone offline...").style("pointer-events","all")},8e3))},8e3),d3.selectAll(".on-map-view").style({visibility:"visible"}),api.lastfm.send("user.gettopartists",[["user",t],["period","12months"],["limit","50"]],l),api.getFriends(function(e,a){try{var n=a.friends.user,i=0,r=d3.select("#friend-name"),o=function(){r.html(""),r.append("a").attr({href:window.location.origin+window.location.pathname+"?username="+n[i].name,target:"_self"}).html(n[i].name)};d3.selectAll(".arrow").on("click",function(){i=d3.select(this).classed("left")?0===i?n.length-1:i-1:(i+1)%n.length,o()}),o(),d3.select("#friends #msg").html("Check out "+t+"'s friends"),d3.select("#friends").transition().duration(1e3).style("opacity",1)}catch(s){console.error(s)}}),CACHED_USERS[t])console.log("No new artists on last.fm!"),n=JSON.parse(window.localStorage.countryCountObj),api.lastfm.send("library.getartists",[["user",t],["limit",1],["page",1]],function(t,e){SESSION.total_artists=+e.artists["@attr"].total}),setTimeout(function(){map.putCountryCount(n),d()},1e3);else{var a=window.localStorage.theme;window.localStorage.clear(),a&&(window.localStorage.theme=a),s()}},d=function(){var e=d3.select(".loader");e.transition().duration(2e3).style("opacity",0).each("end",function(){e.remove()}),d3.select("#progress-text").transition().delay(5e3).duration(1500).style("opacity",0),CACHED_USERS={},CACHED_USERS[t]=(new Date).getTime(),window.localStorage.cached_users=JSON.stringify(CACHED_USERS),window.localStorage.countryCountObj=JSON.stringify(n)},u=window.location.href.split("username=")[1];u?(window.addEventListener("keydown",function(t){switch(t.keyCode){case 83:screenshot.render(),ga("send",{hitType:"event",eventCategory:"Hotkeys",eventAction:"Take screenshot",eventLabel:"test"});break;case 84:nextTheme(),ga("send",{hitType:"event",eventCategory:"Hotkeys",eventAction:"Cycle theme",eventLabel:"test"})}}),u.length>15&&(u=u.substr(0,15)),t=u,SESSION.name=u,c()):(d3.select("#welcome-container").style("visibility","visible"),d3.select("#randomCountry").html(o[Math.floor(Math.random()*o.length)]+"?"))}();var map={},colorArray=["#feebe2","#feebe2","#fcc5c0","#fa9fb5","#f768a1","#dd3497","#ae017e","#7a0177"],legend,countryScore=0;!function(t,e){function a(){w=t.innerHeight-5,A=e.getElementById("map-container").offsetWidth}function n(t){if(countryCount[t.id]){var e=0;for(i=0;i<countryCount[t.id].length;i++)e+=countryCount[t.id][i].playcount;return e}return 0}function r(){var t=countryScore/197;return t}function o(t){return t.toString().replace(/\B(?=(\d{3})+(?!\d))/g," ")}function s(t){for(var e=t.length-1;e>0;e--){var a=Math.floor(Math.random()*(e+1)),n=t[e];t[e]=t[a],t[a]=n}return t}function l(){var t=-1;switch(D){case"artists":for(t=F,i=0;i<5;i++)L[i]=Math.pow(Math.E,Math.log(t)/6*(i+1));L=[0,1,L[0],L[1],L[2],L[3],L[4]];break;case"scrobbles":for(t=U,i=0;i<7;i++)L[i]=Math.pow(Math.E,Math.log(t)/7*(i+1));L=[0,1,L[1],L[2],L[3],L[4],L[5]]}M=d3.scale.threshold().domain(L).range(colorArray)}function c(){for(var t=0,e=L.length;e>t;)L[t]=Math.ceil(L[t]),t++;var a=[o(L[0])+"",L[1]+"-"+(L[2]-1),L[2]+"-"+(L[3]-1),L[3]+"-"+(L[4]-1),L[4]+"-"+o(L[5]-1),o(L[5])+"-"+o(L[6]-1),"> "+o(L[6])];x.select("g#legend").selectAll("g.legend").remove(),legend=x.select("g#legend").selectAll("g.legend").data(L);var n=20,i=20,t=.03*A,r=.03*w,s=x.select("#filter-text").attr("x",t).attr("y",w-r-L.length*i-1.5*i).text("Number of "),l=x.select("#filter").attr("x",t+s[0][0].getComputedTextLength()+5).attr("y",w-r-L.length*i-1.5*i).text(D);l.on("click",function(){D="artists"===D?"scrobbles":"artists",g()});var c=legend.enter().append("g").attr("class","legend");c.append("rect").attr("x",t).attr("y",function(t,e){return w-e*i-2*i-r}).attr("width",n).attr("height",i).style("fill",function(t){return M(t)}),c.append("text").attr("x",t+30).attr("y",function(t,e){return w-e*i-i-4-r}),legend.selectAll("text").data(L).text(function(t,e,n){return a[n]})}function d(t,a){k=d3.geo.naturalEarth().translate([t/2,a/2+.08*a]).scale(t/1.7/Math.PI),R=d3.geo.path().projection(k),x=d3.select("#map-container").append("svg").attr("width",t).attr("height",a).style("margin-left",e.getElementById("map-container").offsetWidth/2-t/2).call(N).on("click",h).append("g"),_=x.append("g"),x.append("g").attr("id","legend"),x.append("text").attr({id:"filter-text","class":"legend"}),x.append("text").attr({id:"filter","class":"legend"})}function u(t,a){var i=_.selectAll(".country").data(t);d3.select("#progress-bar").style({height:100*r()+"%","background-color":colorArray[6]});d3.select("#countryCount").style({"background-color":colorArray[1],"border-color":colorArray[6]}).on("mousemove",function(){d3.select("#progress-text").transition().duration(150).style("opacity",.9)}).on("mouseout",function(){d3.select("#progress-text").transition().duration(150).style("opacity",0)}),d3.select("#progress-text").html("Scrobbled from "+countryScore+"/197 countries"),a&&i.enter().insert("path").attr("class","country").attr("d",R).attr("id",function(t,e){return t.id}).attr("title",function(t,e){return t.properties.name}).style("fill",function(){return M(0)}),i.transition().style("fill",function(t){switch(D){case"artists":return M(countryCount[t.id]?countryCount[t.id].length:0);case"scrobbles":return M(n(t))}}),B=e.getElementById("map-container").offsetLeft,H=e.getElementById("map-container").offsetTop,i.on("mousemove",function(t,e){var a,i;O.forEach(function(e,n){e.id===t.id&&(a=e.name,i=e.tag)});var r=d3.mouse(x.node()).map(function(t){return parseInt(t)});j.classed("hidden",!1).attr("style","left:"+(r[0]+B+20)+"px;top:"+(r[1]+H+10)+"px").html(a+(countryCount[t.id]?"<br>"+countryCount[t.id].length+" artists, "+o(n(t))+" scrobbles":""))}).on("mouseout",function(t,e){j.classed("hidden",!0)}).on("click",function(t,e){var a,n,i;C(t),O.forEach(function(e,r){e.id===t.id&&(a=e.name,n=e.tag,i=t.id)});d3.mouse(x.node()).map(function(t){return parseInt(t)});J.on("click",function(t,e){v(),C(I)})})}function g(t){a(),t&&(d3.select("svg").remove(),d(A,w)),F=d3.max(d3.keys(countryCount),function(t){return countryCount[t].length}),U=d3.max(d3.keys(countryCount),function(t){return n({id:t})}),l(),c(),u(E,t)}function f(t,e,a){var n=t||(d3.event?d3.event.translate:!1)||N.translate(),i=e||(d3.event?d3.event.scale:!1)||N.scale();t||e||!I||(T(!1),v(),I=null);var r=w/4;n[0]=Math.min(A/w*(i-1),Math.max(1.2*A*(1-i),n[0])),n[1]=Math.min(r*(i-1)+r*i,Math.max(w*(1-i)-r*i,n[1])),N.translate(n),N.scale(i),a?_.transition().duration(950).attr("transform","translate("+n+")scale("+i+")"):_.attr("transform","translate("+n+")scale("+i+")"),d3.selectAll(".country").style("stroke-width",1.5/i)}function m(){t.clearTimeout(Y),Y=t.setTimeout(function(){g(!0),f([0,0],1)},200)}function h(){k.invert(d3.mouse(this))}function S(t){function e(){r(d+1,d+5,!1),ga("send",{hitType:"event",eventCategory:"Artist viewer",eventAction:"Next five",eventLabel:"test"})}function a(){r(d-9,d-5,!1),ga("send",{hitType:"event",eventCategory:"Artist viewer",eventAction:"Previous five",eventLabel:"test"})}function r(n,r,o){for(d3.selectAll(".scrobbled").remove(),i=n-1;i<=r-1;i++)if(countryCount[t.id][i]){var s=d3.select("#details").append("div").attr({"class":"scrobbled artist-div lowlight","data-artist":countryCount[t.id][i].artist}).on("click",function(){d3.selectAll(".artist-div").classed({lowlight:!0,highlight:!1}),d3.select(this).classed({highlight:!0,lowlight:!1}),b(d3.select(this).attr("data-artist"),[])}),l=s.append("a").style("display","block");l.append("div").attr("class","image-div").style("background-image","url('"+countryCount[t.id][i].image+"' )");var c=s.append("div").attr("class","play-count-div");c.append("p").html("<b>"+countryCount[t.id][i].artist+"</b><br>"+countryCount[t.id][i].playcount+" scrobbles").attr("class","details-p"),u++}else i=r;d>n?d=5*Math.ceil((d-u)/5):r>d&&(d+=u),u=0,d>=10&&!o?d3.selectAll(".artist-control.left").classed("disabled",!1).on("click",function(){a()}):d3.selectAll(".artist-control.left").classed("disabled",!0).on("click",function(){d3.select(this).on("click",null)}),d>countryCount[t.id].length-1?d3.selectAll(".artist-control.right").classed("disabled",!0).on("click",function(){d3.select(this).on("click",null)}):d3.selectAll(".artist-control.right").classed("disabled",!1).on("click",function(){e()})}var l,c;if(O.forEach(function(e,a){e.id===t.id&&(l=e.name,c=e.tag)}),d3.select("#recommendations").html(""),P.classed("hidden",!1).transition().style("opacity",1).duration(750),d3.selectAll("#countryCount, .on-map-view").classed("hidden",!0),J=d3.select("#infoContainer").append("button").attr("type","button").attr("class","close-button").html("X"),W.append("div").attr("class","cnameContainer").attr("id","cnameCont").append("h1").html(l),d3.select("#cnameCont").append("h5").html(function(){return countryCount[t.id]?o(countryCount[t.id].length)+" artists, "+o(n(t))+" scrobbles":"No artists yet - Find new here ->"}),countryCount[t.id]){var d=0,u=0;d3.select("#details").append("div").html('<span>Your top artists tagged with </span><span class="demonym">#'+l+'</span><span> or </span><span class="demonym">#'+c+"</span><span>: </span>").attr("class","topartists-desc"),d3.select("#artistContainer").append("i").attr("class","fa artist-control right fa-angle-right").on("click",function(){e()}),d3.select("#artistContainer").append("i").attr("class","fa artist-control left disabled fa-angle-left").on("click",function(){a()}),r(1,5,!0)}else console.log("landet har inga lyssnade artister");d3.select("#recommendations").append("h4").html("You may like: ").attr("class","topartists-desc");var g=d3.select("#recommendations").append("div").attr("class","recLoadingDiv"),f=g.append("span").attr("id","rec-loading").html("Looking for artists tagged #"+c);g.append("img").attr({id:"rec-loading-img",src:"assets/img/loader_horizontal.gif"}).style({display:"inline-block",margin:"0 5px"}),g.append("span").attr("id","rec-loading-current"),api.getRecommendations(c,function(e){I&&I.id===t.id&&(f.html("Looking for artists tagged #"+l),api.getRecommendations(l,function(a){if(I&&I.id===t.id){f.html("Loading images for recommended artists");for(var n=e.concat(a),i={},r=0;r<n.length;r++)i[n[r].name]=n[r];n=new Array;for(key in i)n.push(i[key]);for(n.sort(function(t,e){return e.count<t.count?-1:e.count>t.count?1:0}),n=n.slice(0,20),n=s(n),0===n.length&&(g.remove(),d3.select("#recommendations").append("p").html("We couldn't find any good "+c+" recommendations for you :-( "),d3.select("#recommendations").append("a").attr({href:"http://www.last.fm/tag/"+l,target:"_blank"}).html("Try searching last.fm yourself!")),r=0;r<Math.min(n.length,5);r++){if(I.id!==t.id)return;api.getArtistInfo(n[r].name,function(t){g.remove();var e=(t[0].url,t[0].image),a=t[0].name,n=d3.select("#recommendations").insert("div","#summaryText").attr("class","artist-div lowlight"),i=n.append("a").style("display","block");i.append("div").attr("class","image-div").style("background-image","url('"+e+"')");var r=n.append("div").attr("class","recoArtistInfoDiv");r.append("p").html("<b>"+a+"</b>").attr("class","details-p"),n.on("click",function(){d3.selectAll(".artist-div").classed({lowlight:!0,highlight:!1}),d3.select(this).classed({highlight:!0,lowlight:!1}),b(a)})})}}}))})}function v(){P.transition().style("opacity",0).duration(1e3),P.classed("hidden",!0),d3.selectAll("#countryCount, .on-map-view").classed("hidden",!1),d3.selectAll(".artist-div").remove("div"),d3.selectAll(".close-button").remove("button"),d3.selectAll(".details-h").remove("p"),d3.selectAll(".details-h4").remove("h4"),d3.selectAll(".recom-h4").remove("h4"),d3.selectAll(".artist-control").remove(),d3.selectAll(".topartists-desc").remove(),W.classed("hidden",!0),d3.select("#cnameCont").remove("h1"),d3.select("#cnameCont").remove("h5")}function b(a){var n=[],r=[];d3.select("#summaryText").remove();var o=d3.select("#recommendations").append("div").attr("class","summaryText").attr("id","summaryText");d3.select("#summaryText").append("span").html("Loading description of "+a),d3.select("#summaryText").append("img").attr({id:"sum-loading-img",src:"assets/img/loader_horizontal.gif"}).style({display:"inline-block",margin:"0 5px"}),api.getArtistInfo(a,function(s){var l=s[0].description.replace(/(\n)+/g,"<br />");for(r=s[0].tags,y=0;y<15;y++)for(z=0;z<r.length;z++)r[z]===USER_TAGS[y].tag&&n.push(USER_TAGS[y].tag);var c=n.concat(r);c=c.filter(function(t,e){return c.indexOf(t)==e}),d3.select("#summaryText").html("");var d=.9*t.innerHeight-e.getElementById("artistContainer").offsetHeight;for(o.style("max-height",d+"px"),o.append("h4").html(a),i=0;i<Math.min(c.length,6);i++){var u=o.append("div").attr("class","tagdiv").append("h4").html("#"+c[i]);for(p=0;p<n.length;p++)c[i]===n[p]&&u.classed("usertag",!0)}o.append("p").html(l||"No description available - <a href='http://last.fm/music/"+a+"' target='_blank'>check out last.fm.</a>")})}function T(t,a){if(d3.selectAll(".country").classed("highlighted",!1),t){d3.selectAll(".country").transition().style("opacity",function(){return+this.id===+a.id?1:.3});var n=d3.select(e.getElementById(""+a.id));n.classed("highlighted",!0)}else d3.selectAll(".country").transition().style("opacity",1)}function C(t){var e,a,i,r=R.bounds(t);n(t);var o=r[1][0]-r[0][0],s=r[1][1]-r[0][1];if(80>o&&(o=80),t&&I!==t)switch(I=t,v(),S(t),T(!0,t),t.id){case 840:i=3,e=-(r[1][0]+r[0][0])/3,a=-(r[1][1]+r[0][1])/1.7;break;case 250:i=7.012,e=-(r[1][0]+r[0][0])/1.8,a=-(r[1][1]+r[0][1])/3.4;break;case 528:i=9.0124,e=-(r[1][0]+r[0][0])/1.5,a=-(r[1][1]+r[0][1])/3.3;break;case 643:i=1.9,e=-(r[1][0]+r[0][0])/1.25,a=-(r[1][1]+r[0][1])/2;break;case 554:i=4,e=-(r[1][0]+r[0][0])/.9,a=-(r[1][1]+r[0][1])/1.8;break;case 36:i=3.3,e=-(r[1][0]+r[0][0])/1.8,a=-(r[1][1]+r[0][1])/2.1;break;default:i=.55/Math.max(o/A,s/w),e=-(r[1][0]+r[0][0])/2-A/i/4,a=-(r[1][1]+r[0][1])/2}else e=-A/2,a=-w/2-.08*w,i=1,v(),T(!1),I=null;var l=k.translate();f([l[0]+e*i,l[1]+a*i],i,!0)}d3.select(t).on("resize",m);var w,A,E,k,R,x,_,O,I,D="artists",N=d3.behavior.zoom().scaleExtent([1,9]).on("zoom",f);countryCount={};var M,L=[0,1,2,3,4,5,6],F=1,U=0,G=t.localStorage.theme||"pink_white";map.drawPlays=function(){D="scrobbles",g()};var J,B,H,j=d3.select("#map-container").append("div").attr("class","tooltip hidden"),P=d3.select("body").append("div").attr("class","infoContainer hidden").attr("id","infoContainer"),W=(d3.select("#infoContainer").append("div").attr("class","artistContainer").attr("id","artistContainer"),d3.select("#infoContainer").append("div").attr("class","cnameDiv").attr("id","cname")),X=(d3.select("#artistContainer").append("div").attr("class","detailsDiv").attr("id","details"),d3.select("#artistContainer").append("div").attr("class","recoDiv").attr("id","recommendations"),d3.select("#artistContainer").append("div").attr("class","artistSummaryDiv").attr("id","summary"),{blue_black:["#03020D","#140E1F","#2A075A","#321C78","#362688","#3E3CA7","#4651C5","#5371F4"],green_black:["#03020D","#08120C","#032F30","#064137","#0E6745","#158C54","#1CB162","#28EA78"],pink_black:["#03020D","#1F0310","#4B0627","#5C1138","#7E285C","#A13F80","#C355A4","#F778DA"],pink_white:["#feebe2","#feebe2","#fcc5c0","#fa9fb5","#f768a1","#dd3497","#ae017e","#7a0177"],green_white:["#ece2f0","#F6EBFA","#ccece6","#99d8c9","#66c2a4","#41ae76","#238b45","#006d2c"],red_white:["#F0F0D8","#F0F0D8","#feb24c","#fd8d3c","#fc4e2a","#e31a1c","#bd0026","#800026"]});nextTheme=function(a){var n=d3.keys(X);G=a||n[(n.indexOf(G)+1)%n.length],colorArray=X[G],d3.select(e.body).attr("class",G),t.localStorage.theme=G,E&&g()},map.nextTheme=nextTheme,nextTheme(G),l(),a(),d(A,w),t.localStorage.countries?O=JSON.parse(t.localStorage.countries):d3.csv("assets/data/countries.csv",function(e,a){O=a,a.forEach(function(t){t.id=+t.id}),t.localStorage.countries=JSON.stringify(a)}),d3.json("assets/data/world-50m.json",function(t,e){var a=topojson.feature(e,e.objects.countries).features;E=a,u(E,!0)}),map.move=f;var Y;map.putCountryCount=function(e){countryCount=JSON.parse(JSON.stringify(e)),countryScore=0;var a=[];d3.keys(countryCount).forEach(function(t){countryCount[t][SESSION.name]&&(countryCount[t]=countryCount[t][SESSION.name],countryScore+=1,a.push(+t))}),E&&g(),t.countryScore=countryScore}}(window,document);var screenshot={};!function(t,e){screenshot.render=function(){var a,n=new Image,i=d3.select("svg"),r=i.attr("width"),o=i.attr("height"),s=e.createElement("canvas"),l=s.getContext("2d"),c=t.getComputedStyle(e.body).backgroundColor,d=t.getComputedStyle(e.body).color,u=function(t){l.font=t.font,l.fillText(t.string,r/2-l.measureText(t.string).width/2,t.y),t.lineWidth&&(l.lineWidth=t.lineWidth,l.strokeStyle=t.strokeStyle,l.strokeText(t.string,r/2-l.measureText(t.string).width/2,t.y))};s.width=r,s.height=o,i.insert("rect","g").attr({id:"background-rect",width:"100%",height:"100%"}).style({fill:c}),d3.selectAll(".legend text, text.legend").style({"font-family":function(){return t.getComputedStyle(this).fontFamily},"font-size":function(){return t.getComputedStyle(this).fontSize},fill:d}),d3.selectAll(".legend rect").style({stroke:c}),canvg(s,(new XMLSerializer).serializeToString(i[0][0])),n.onload=function(){l.save(),l.globalAlpha=.6,l.fillStyle=c,scoreString=SESSION.total_artists+" artists from "+countryScore+" / 197 countries",a=SESSION.name+"'s musical world map",l.font="34px Patua One",l.fillRect(r/2-l.measureText(a).width/2-20,o-110,l.measureText(a).width+40,100),l.fillStyle=d,l.fillStyle=d,u({string:a,font:"34px Patua One",y:o-60}),u({string:scoreString,font:"20px Didact Gothic",y:o-40}),l.restore(),l.drawImage(n,r-130,o-60,100,36),d3.select("#background-rect").remove(),e.getElementById("screenshot-img").src=s.toDataURL(),t.open(s.toDataURL(),"_blank")},n.src="assets/img/explrlogo.png"}}(window,document);
//# sourceMappingURL=sourcemaps/all.min.js.map
