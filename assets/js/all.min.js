"use strict";function ownKeys(e,t){var n,a=Object.keys(e);return Object.getOwnPropertySymbols&&(n=Object.getOwnPropertySymbols(e),t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),a.push.apply(a,n)),a}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ownKeys(Object(n),!0).forEach(function(t){_defineProperty(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ownKeys(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}function _defineProperty(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function _slicedToArray(t,e){return _arrayWithHoles(t)||_iterableToArrayLimit(t,e)||_unsupportedIterableToArray(t,e)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(t,e){if(t){if("string"==typeof t)return _arrayLikeToArray(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Map"===(n="Object"===n&&t.constructor?t.constructor.name:n)||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(t,e):void 0}}function _arrayLikeToArray(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,a=new Array(e);n<e;n++)a[n]=t[n];return a}function _iterableToArrayLimit(t,e){var n=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=n){var a,r,o=[],i=!0,s=!1;try{for(n=n.call(t);!(i=(a=n.next()).done)&&(o.push(a.value),!e||o.length!==e);i=!0);}catch(t){s=!0,r=t}finally{try{i||null==n.return||n.return()}finally{if(s)throw r}}return o}}function _arrayWithHoles(t){if(Array.isArray(t))return t}(api=api||{}).lastfm={},api.lastfm.key="865b1653dbe200905a5b75d9d839467a",api.lastfm.url="https://ws.audioscrobbler.com/2.0/",function(p){function m(t,e){b[t].total++,b[t].success+=e?1:0,b[t].fails+=e?0:1}var h=0,y=["7a9619a850ccf7377c46cf233c51e3c6","13893ba930c63b1b2cbe21441dc7f550","4cb074e4b8ec4ee9ad3eb37d6f7eb240","4a9f5581a9cdf20a699f540ac52a95c9","57ee3318536b23ee81d6b27e36997cde","865b1653dbe200905a5b75d9d839467a","68b2125fd8f8fbadeb2195e551f32bc4","1ba315d4d1673bbf88aed473f1917306"],b=window.keyInfo={};y.forEach(function(t){return b[t]={success:0,fails:0,total:0}});p.lastfm.send=function(i,s,t,l){l=void 0===l?10:l;var c,d,u=!1;function f(a,r){e=y.reduce(function(t,e,n,a){return t+b[e].fails/a.length},0);var e,t,n,o=(t=(t=y.filter(function(t){return b[t].fails<=e})).length?t:y)[++h%t.length];c=d3.json((n=p.lastfm.url+"?method="+i+"&api_key="+o+"&format=json",s.forEach(function(t){n+="&"+t[0]+"="+(t[1]+"").replace("&","%26").replace("/","%2F").replace("+","%2B").replace("\\","%5C")}),n),function(t,e){if(u)clearTimeout(g);else{if(t?e=JSON.parse(t.response):e.error&&(t=e),t){m(o,!1);var n={method:i,errorCode:t&&t.error,try:a,options:s,key:o,message:t.message||(null===(n=JSON.parse(t.response))||void 0===n?void 0:n.message)};if(a<l)return console.warn("Retry request: ",n),void setTimeout(f.bind(null,a+1,r),3e3*a);l<=a&&(console.warn("Retry failed after "+l+" attempts, will stop trying.",n),clearTimeout(g),u=!0,t="ERROR",e={error:"Took to long to respond"})}else m(o,!0);d=!0,r(t,e)}})}f(0,t);var g=setTimeout(function(){d||(c.abort(),t("ERROR",{error:"Took to long to respond"}))},2e4);return{abort:function(){u=!0,c.abort()}}}}(api);var STORED_ARTISTS,CACHED_NO_COUNTRIES,api=api||{},superCount=0,utils=(!function(){api.getCountriesData=function(){return t=t||new Promise(function(n,t){d3.csv("assets/data/countries.csv",function(t,e){e.forEach(function(t){t.id=+t.id,t.names=t.names?t.names.split("|"):[],t.tags=t.tags?t.tags.split("|"):[],t.mainName=t.names[0],t.tag=t.tags[0],t.name=t.mainName}),n(e)})})},Promise.all([api.getCountriesData(),new Promise(function(n,a){return d3.json("assets/data/artist-countries.json",function(t,e){return t?a(t):n(e)})})]).then(function(t){var t=_slicedToArray(t,2),e=t[0],n=t[1],e=e.map(function(e){var t=[];return 1===e.names.length&&0===e.tags.length&&(t=[e]),1<e.names.length&&(t=t.concat(e.names.map(function(t){return _objectSpread(_objectSpread({},e),{},{name:t})}))),0<e.tags.length&&(t=t.concat(e.tags.map(function(t){return _objectSpread(_objectSpread({},e),{},{tag:t})}))),1<e.names.length&&0<e.tags.length&&t.splice(0,1),t}).flat(),s=d3.nest().key(function(t){return t&&t.tag?t.tag.toLowerCase():""}).map(e),l=d3.nest().key(function(t){return t.name.toLowerCase()}).map(e);api.getCountry=function(o,i){var t;if(n[o])return t=n[o].toLowerCase(),console.log('Using hardcoded country tag "'.concat(t,'" for artist "').concat(o,'"')),void i({artist:o,tag:t,id:l[t][0].id,country:l[t][0].mainName});api.lastfm.send("artist.gettoptags",[["artist",o]],function(t,e){var a,r,n;!t&&e.toptags&&e.toptags.tag&&e.toptags.tag.length?(t=[].concat(["georgia","ireland"],["spanish","french","english","portuguese","russian","italian","japanese","korean","indian","swedish","irish"]),r=a={tag:"",id:null,country:"",count:0},e.toptags.tag.some(function(t,e){var n=t.name.toLowerCase();if(r.id&&a.id)return!0;try{!r.id&&l[n]&&l[n][0].id&&(r={tag:n,id:l[n][0].id,country:l[n][0].mainName,count:t.count}),!a.id&&s[n]&&s[n][0].id&&(a={tag:n,id:s[n][0].id,country:s[n][0].name,count:t.count})}catch(t){}}),n=r.id&&a.count<8*r.count?r:a.id?a:{},"georgia"===r.tag&&e.toptags.tag.some(function(t){return["american","us","usa"].includes(t.name.toLowerCase())})&&(n=a,console.info("'"+o+"' is tagged with 'georgia', but I'm gonna go ahead and guess they're really from the U.S.")),t.includes(n.tag)&&console.info("Potentially incorrect country for '"+o+"': "+n.country+", using the tag '"+n.tag+"'"),i(Object.assign({artist:o},n))):i({artist:o})})},api.getCountries=function(t,e){function a(){n++,superCount++,d3.select("#loading-text").html("Loading artists...<br>("+superCount+"/"+SESSION.total_artists+")<br>You can start exploring,<br>but it might interfere<br>with loading your artists."),n===t.length&&localforage.setItem("artists",STORED_ARTISTS,function(t){t&&console.error("Failed saving artists to storage: ",t),e(r)})}var r=[],n=0;t.forEach(function(e,t){var n;STORED_ARTISTS[e]&&STORED_ARTISTS[e].country?((n=STORED_ARTISTS[e].country).artist=e,r.push(n),a()):((new Date).getTime(),api.getCountry(e,function(t){STORED_ARTISTS[e]=STORED_ARTISTS[e]||{},STORED_ARTISTS[e].country={id:t.id,name:t.name},r.push(t),a()}))})}}),api.getTags=function(n,a){STORED_ARTISTS[n]&&STORED_ARTISTS[n].tags?a(STORED_ARTISTS[n].tags):(STORED_ARTISTS[n]=STORED_ARTISTS[n]||{},STORED_ARTISTS[n].tags=[],api.lastfm.send("artist.gettoptags",[["artist",n]],function(t,e){STORED_ARTISTS[n].tags=e.toptags.tag,localforage.setItem("artists",STORED_ARTISTS,function(t){t&&console.error("Failed saving artists to storage: ",t),a(STORED_ARTISTS[n].tags)})}))},api.getArtistInfo=function(a,r){var o=[];api.lastfm.send("artist.getinfo",[["artist",a]],function(t,e){var n=[];e.artist.tags.tag&&e.artist.tags.tag.forEach(function(t,e){n.push(t.name)}),o.push({name:a,url:e.artist.url,image:e.artist.image[3]["#text"],description:e.artist.bio.summary,tags:n}),r(o)})};var t,n=[];api.cancelRecommendationRequests=function(){n.forEach(function(t){t.abort()}),n=[]},api.getRecommendations=function(l,c){api.cancelRecommendationRequests();var d=[],t=USER_TAGS.slice(0,15),u=d3.nest().key(function(t){return t.tag}).rollup(function(t){return t[0].count}).map(t),t=api.lastfm.send("tag.gettopartists",[["tag",l],["limit",100]],function(t,e){var i,s={};!t&&!e.error&&e.topartists&&e.topartists.artist?(i=e.topartists.artist).forEach(function(r,o){s[r.name]=[];var t=api.lastfm.send("artist.gettoptags",[["artist",r.name]],function(t,e){var n=!e.error&&!!e.toptags.tag;if((d3.select("#rec-loading-current").html("("+r.name+")"),n)&&d3.nest().key(function(t){return t.name}).map(e.toptags.tag)[l])for(var a=e.toptags.tag.length-1;0<=a;a--)u[e.toptags.tag[a].name]&&5<e.toptags.tag[a].count&&s[r.name].push(e.toptags.tag[a].name);o===i.length-1&&(d3.keys(s).forEach(function(t){d.push({name:t,count:s[t].length,tags:s[t]})}),d.sort(function(t,e){return e.count<t.count?-1:e.count>t.count?1:0}),c(d))});n.push(t)}):c([])});n.push(t)},api.getFriends=function(t){api.lastfm.send("user.getFriends",[["user",SESSION.name]],t)}}((window,document)),utils||{}),STORED_ARTISTS_PROMISE=(utils.exportToCSV=function(n){var t=map.countryNames.map(function(t){var e=n[t.id];return{countryId:t.id,countryName:t.mainName,artists:e&&e[SESSION.name]||[]}}),t="data:text/csv;charset=utf-8,"+(t=json2csv.parse(t.sort(function(t,e){t=t.countryName,e=e.countryName;return t.localeCompare(e,"en")}),{fields:[{label:"Country",value:"countryName"},{label:"Number of artists",value:function(t){return t.artists.length}},{label:"Scrobbles",value:function(t){return t.artists.reduce(function(t,e){return t+e.playcount},0)}}]})).replaceAll('"',"");window.open(encodeURI(t))},localforage.getItem("artists").then(function(t){return STORED_ARTISTS=t||{}})),CACHED_NO_COUNTRIES_PROMISE=localforage.getItem("no_countries").then(function(t){return CACHED_NO_COUNTRIES=t||{}}),USER_TAGS=[],CACHED_USERS=JSON.parse(window.localStorage.cached_users||"{}"),SESSION={};function clearExplrCache(){var t=window.localStorage.getItem("theme");return window.localStorage.clear(),window.localStorage.setItem("theme",t),localforage.clear()}var legend,countryCountObj={},map=(!function(){function a(){api.lastfm.send("library.getartists",[["user",i],["limit",50],["page",o]],function(t,e){if(""===e)return console.error('Got empty string ("") as response, skipping page.'),o++,void a();if(t||e.error)return console.error("Error in getAllArtists, page "+o,t,e),void(s++<5?a():confirm("Last.fm took too long to respond.\n\nPress OK to refresh the page and try again, or Cancel to use the page as it is.")&&clearExplrCache().then(function(){c("artists",STORED_ARTISTS,function(){window.location.reload()})}));if(s=0,1===o&&(SESSION.total_artists=+e.artists["@attr"].total,r=+e.artists["@attr"].totalPages,0===SESSION.total_artists))return d3.select(".bubblingG").remove(),d3.select("#loading-text").html("You haven't listened to any<br> artists yet. Start scrobbling with <br>                                                        <a href='http://evolver.fm/2012/05/08/how-to-scrobble-to-last-fm-from-itunes-spotify-and-more/'>your favorite music player!</a>"),void d3.select(".loader").style("pointer-events","all");o++;var n=[];e.artists.artist.forEach(function(t){var e=STORED_ARTISTS[t.name]||{};e.playcount=+t.playcount,e.url=t.url,STORED_ARTISTS[t.name]=e,n.push(t.name)}),c("artists",STORED_ARTISTS),api.getCountries(n,function(t){var e=d3.nest().key(function(t){return t.id}).rollup(function(t){return t}).map(t);d3.keys(e).forEach(function(t){countryCountObj[t]=countryCountObj[t]||{},countryCountObj[t][i]=countryCountObj[t][i]||[];var n=countryCountObj[t][i];(n=n.concat(e[t])).forEach(function(t,e){n[e].url=STORED_ARTISTS[t.artist].url,n[e].playcount=STORED_ARTISTS[t.artist].playcount}),countryCountObj[t][i]=n}),l(t.filter(function(t){return!t.id})),map.putCountryCount(countryCountObj),(r<o?u:a)()})})}function d(t,e){(t||e.error)&&e&&6===e.error&&(alert("User not found"),window.location.assign(window.location.origin+window.location.pathname));var i=0,s={},l=e.topartists.artist;l.forEach(function(t,e){setTimeout(function(){api.lastfm.send("artist.gettoptags",[["artist",t.name]],function(t,e){var a,n=e.toptags&&e.toptags.tag;if(n)for(var r=Math.min(n.length,10),o=0;o<r;o++)s[n[o].name]?s[n[o].name]++:s[n[o].name]=1;++i==l.length-1&&(USER_TAGS=[],a=["american","swedish","british","female vocalists","male vocalists","german","seen live","english","singer-songwriter","spanish","french"],d3.keys(s).forEach(function(t){for(var e=!1,n=0;n<a.length;n++)t===a[n]&&(e=!0);e||USER_TAGS.push({tag:t,count:s[t]})}),USER_TAGS.sort(function(t,e){return e.count<t.count?-1:e.count>t.count?1:0}),console.info("Done getting tags, saved to localStorage.user_tags"),window.localStorage.user_tags=JSON.stringify(USER_TAGS))})},3e3*Math.random())})}var i,r,o=1,s=0,t=["Malawi","Malaysia","Peru","Sierra Leone","Trinidad & Tobago","Greece","Laos","Iran","Haiti","Nicaragua","Mongolia","Slovakia"],n=[],l=function(t){n=n.concat(t);var e=d3.select(".no-countries ul");t.forEach(function(t){e.append("li").html('<a href="'+t.url+'" target="blank" class="no-countries__link">'+t.artist+"</a>")}),d3.select(".no-countries__info").html(n.length+" artists without a country:"),c("no_countries",n),n.length&&d3.select(".no-countries").style({visibility:"visible","pointer-events":"all"})},u=function(){var t=d3.select(".loader");t.transition().duration(2e3).style("opacity",0).each("end",function(){t.remove()}),d3.select("#progress-text").transition().delay(5e3).duration(1500).style("opacity",0),(CACHED_USERS={})[i]=(new Date).getTime(),window.localStorage.cached_users=JSON.stringify(CACHED_USERS),window.localStorage.countryCountObj=JSON.stringify(countryCountObj)},e=window.location.href.split("username=")[1],c=(e?(window.addEventListener("keydown",function(t){switch(t.keyCode){case 83:screenshot.render(),ga("send",{hitType:"event",eventCategory:"Hotkeys",eventAction:"Take screenshot",eventLabel:"test"});break;case 84:nextTheme(),ga("send",{hitType:"event",eventCategory:"Hotkeys",eventAction:"Cycle theme",eventLabel:"test"})}}),15<e.length&&(e=e.substr(0,15)),i=e,SESSION.name=e,Promise.all([CACHED_NO_COUNTRIES_PROMISE,STORED_ARTISTS_PROMISE]).then(function(){return ga("send","event","splash screen","Go!","test"),(e=d3.select("#welcome-container")).transition().duration(2e3).style("opacity",0).each("end",function(){e.remove()}),d3.select(".loader").transition().duration(2e3).style("opacity",1),d3.select("#loading-text").html("Getting library..."),setTimeout(function(){"Getting library..."===d3.select("#loading-text").html()&&(d3.select("#loading-text").html("Last.fm is taking<br>a long time to<br>respond..."),setTimeout(function(){"Last.fm is taking<br>a long time to<br>respond..."===d3.select("#loading-text").html()&&d3.select("#loading-text").html("Maybe <a href='http://last.fm' target='_blank'>last.fm</a> has<br>gone offline...").style("pointer-events","all")},8e3))},8e3),d3.selectAll(".on-map-view").style({visibility:"visible"}),api.lastfm.send("user.gettopartists",[["user",i],["period","12months"],["limit","50"]],d),api.getFriends(function(t,e){try{var n=e.friends.user,a=0,r=d3.select("#friend-name"),o=function(){r.html(""),r.append("a").attr({href:window.location.origin+window.location.pathname+"?username="+n[a].name,target:"_self"}).html(n[a].name)};d3.selectAll(".arrow").on("click",function(){a=d3.select(this).classed("left")?0===a?n.length-1:a-1:(a+1)%n.length,o()}),o(),d3.select("#friends #msg").html("Check out "+i+"'s friends"),d3.select("#friends").transition().duration(1e3).style("opacity",1)}catch(t){console.error("getFriends()",t),d3.select("#friends").html("&nbsp;Couldn't find any<br>friends on last.fm :(&nbsp;"),d3.select("#friends").transition().duration(1e3).style("opacity",1)}}),void(CACHED_USERS[i]?(console.info("No new artists on last.fm!"),countryCountObj=JSON.parse(window.localStorage.countryCountObj),localforage.getItem("no_countries",function(t,e){l(e||[])}),api.lastfm.send("library.getartists",[["user",i],["limit",1],["page",1]],function(t,e){SESSION.total_artists=+e.artists["@attr"].total}),setTimeout(function(){map.putCountryCount(countryCountObj),u()},1e3)):(t=window.localStorage.theme,window.localStorage.clear(),t&&(window.localStorage.theme=t),a()));var t,e})):(d3.select("#welcome-container").style("visibility","visible"),d3.select("#randomCountry").html(t[Math.floor(Math.random()*t.length)]+"?")),function(t,e,n){localforage.setItem(t,e,n||function(){})})}(),{}),colorArray=["#feebe2","#feebe2","#fcc5c0","#fa9fb5","#f768a1","#dd3497","#ae017e","#7a0177"],countryScore=0,screenshot=(!function(f,g){d3.select(f).on("resize",function(){f.clearTimeout(t),t=f.setTimeout(function(){M(!0),L([0,0],1)},200)});var s,l,u,p,b,i,o,v,m,c,S,T="artists",w=d3.behavior.zoom().scaleExtent([1,9]).on("zoom",L),h={},d=[0,1,2,3,4,5,6],A=1,E=0,n=f.localStorage.theme||"pink_white";function C(){s=f.innerHeight-5,l=g.getElementById("map-container").offsetWidth}function _(t){if(h[t.id]){for(var e=0,n=0;n<h[t.id].length;n++)e+=h[t.id][n].playcount;return e}return 0}function y(t){return t.toString().replace(/\B(?=(\d{3})+(?!\d))/g," ")}function O(){var t=-1;switch(T){case"artists":for(var t=A,e=0;e<5;e++)d[e]=Math.pow(Math.E,Math.log(t)/6*(e+1));d=[0,1,d[0],d[1],d[2],d[3],d[4]];break;case"scrobbles":t=E;for(var n=0;n<7;n++)d[n]=Math.pow(Math.E,Math.log(t)/7*(n+1));d=[0,1,d[1],d[2],d[3],d[4],d[5]]}c=d3.scale.threshold().domain(d).range(colorArray)}map.drawPlays=function(){T="scrobbles",M()},d3.json("assets/data/playlists.json",function(t,e){S=e});var R,r,k,t,I=d3.select("#map-container").append("div").attr("class","tooltip hidden"),x=d3.select("body").append("div").attr("class","infoContainer hidden").attr("id","infoContainer"),D=(d3.select("#infoContainer").append("div").attr("class","artistContainer").attr("id","artistContainer"),d3.select("#infoContainer").append("div").attr("class","cnameDiv").attr("id","cname")),a=(d3.select("#artistContainer").append("div").attr("class","detailsDiv").attr("id","details"),d3.select("#artistContainer").append("div").attr("class","recoDiv").attr("id","recommendations"),d3.select("#artistContainer").append("div").attr("class","artistSummaryDiv").attr("id","summary"),{blue_black:["#03020D","#140E1F","#2A075A","#321C78","#362688","#3E3CA7","#4651C5","#5371F4"],green_black:["#03020D","#08120C","#032F30","#064137","#0E6745","#158C54","#1CB162","#28EA78"],pink_black:["#03020D","#1F0310","#4B0627","#5C1138","#7E285C","#A13F80","#C355A4","#F778DA"],pink_white:["#feebe2","#feebe2","#fcc5c0","#fa9fb5","#f768a1","#dd3497","#ae017e","#7a0177"],green_white:["#ece2f0","#F6EBFA","#ccece6","#99d8c9","#66c2a4","#41ae76","#238b45","#006d2c"],red_white:["#F0F0D8","#F0F0D8","#feb24c","#fd8d3c","#fc4e2a","#e31a1c","#bd0026","#800026"]}),e=f.nextTheme=function(t){var e=d3.keys(a);n=t||e[(e.indexOf(n)+1)%e.length],colorArray=a[n],d3.select(g.body).attr("class",n),f.localStorage.theme=n,u&&M()};function N(t,e){p=d3.geo.naturalEarth().translate([t/2,e/2+.08*e]).scale(t/1.7/Math.PI),b=d3.geo.path().projection(p),i=d3.select("#map-container").append("svg").attr("id","map-svg").attr("width",t).attr("height",e).style("margin-left",g.getElementById("map-container").offsetWidth/2-t/2).call(w).on("click",P).append("g"),o=i.append("g"),i.append("g").attr("id","legend"),i.append("text").attr({id:"filter-text",class:"legend"}),i.append("text").attr({id:"filter",class:"legend"})}function j(t,e){t=o.selectAll(".country").data(t);d3.select("#progress-bar").style({height:countryScore/210*100+"%","background-color":colorArray[6]});d3.select("#countryCount").style({"background-color":colorArray[1],"border-color":colorArray[6]}).on("mousemove",function(){d3.select("#progress-text").transition().duration(150).style("opacity",.9)}).on("mouseout",function(){d3.select("#progress-text").transition().duration(150).style("opacity",0)}),d3.select("#progress-text").html("Scrobbled from "+countryScore+"/210 countries"),e&&t.enter().insert("path").attr("class","country").attr("d",b).attr("id",function(t,e){return t.id}).attr("title",function(t,e){return t.properties.name}).style("fill",function(){return c(0)}),t.transition().style("fill",function(t){switch(T){case"artists":return h[t.id]?c(h[t.id].length):c(0);case"scrobbles":return c(_(t))}}),r=g.getElementById("map-container").offsetLeft,k=g.getElementById("map-container").offsetTop,t.on("mousemove",function(n,t){v.forEach(function(t,e){t.id===n.id&&(a=t.name,t.tag)});var a,e=d3.mouse(i.node()).map(function(t){return parseInt(t)});I.classed("hidden",!1).attr("style","left:"+(e[0]+r+20)+"px;top:"+(e[1]+k+10)+"px").html(a+(h[n.id]?"<br>"+h[n.id].length+" artists, "+y(_(n))+" scrobbles":""))}).on("mouseout",function(t,e){I.classed("hidden",!0)}).on("click",function(n,t){B(n),v.forEach(function(t,e){t.id===n.id&&(t.name,t.tag,n.id)}),d3.mouse(i.node()).map(function(t){return parseInt(t)});R.on("click",function(t,e){F(),B(m)})})}function M(t){C(),t&&(d3.select("#map-svg").remove(),N(l,s)),A=d3.max(d3.keys(h),function(t){return h[t].length}),E=d3.max(d3.keys(h),function(t){return _({id:t})}),O();for(var e=0,n=d.length;e<n;)d[e]=Math.ceil(d[e]),e++;var a=[y(d[0])+"",d[1]+"-"+(d[2]-1),d[2]+"-"+(d[3]-1),d[3]+"-"+(d[4]-1),d[4]+"-"+y(d[5]-1),y(d[5])+"-"+y(d[6]-1),"> "+y(d[6])],e=(i.select("g#legend").selectAll("g.legend").remove(),legend=i.select("g#legend").selectAll("g.legend").data(d),.03*l),r=.03*s,o=i.select("#filter-text").attr("x",e).attr("y",s-r-20*d.length-30).text("Number of ");i.select("#filter").attr("x",e+o[0][0].getComputedTextLength()+5).attr("y",s-r-20*d.length-30).text(T).on("click",function(){T="artists"===T?"scrobbles":"artists",M()}),d3.select(".no-countries").style("bottom",r+20*d.length+30+30+"px"),(o=legend.enter().append("g").attr("class","legend")).append("rect").attr("x",e).attr("y",function(t,e){return s-20*e-40-r}).attr("width",20).attr("height",20).style("fill",function(t){return c(t)}),o.append("text").attr("x",e+30).attr("y",function(t,e){return s-20*e-20-4-r}),legend.selectAll("text").data(d).text(function(t,e,n){return a[n]}),j(u,t)}function L(t,e,n){var a=t||!!d3.event&&d3.event.translate||w.translate(),r=e||!!d3.event&&d3.event.scale||w.scale(),t=(t||e||!m||(G(!1),F(),m=null),s/4);a[0]=Math.min(l/s*(r-1),Math.max(1.2*l*(1-r),a[0])),a[1]=Math.min(t*(r-1)+t*r,Math.max(s*(1-r)-t*r,a[1])),w.translate(a),w.scale(r),(n?o.transition().duration(950):o).attr("transform","translate("+a+")scale("+r+")"),d3.selectAll(".country").style("stroke-width",1.5/r)}function P(){p.invert(d3.mouse(this))}function U(s){v.forEach(function(t,e){t.id===s.id&&(l=t.name,c=t.tag,n=(t.names||[t.name]).map(function(t){return'<span class="demonym">#'+t+"</span>"}).join(", "),a=(t.tags||[t.tag]).map(function(t){return'<span class="demonym">#'+t+"</span>"}).join(", "))}),d3.select("#recommendations").html(""),x.classed("hidden",!1).transition().style("opacity",1).duration(750),d3.selectAll("#countryCount, .on-map-view").classed("hidden",!0),R=d3.select("#infoContainer").append("button").attr("type","button").attr("class","close-button").html("X"),D.append("div").attr("class","cnameContainer").attr("id","cnameCont").append("h1").html(l),d3.select("#cnameCont").append("h5").html(function(){return h[s.id]?y(h[s.id].length)+" artists, "+y(_(s))+" scrobbles":"No artists yet - Find new here ->"});var l,c,n,a,o,i,t,d,u,r=S.find(function(t){return t.name===l}),g=d3.select("#cnameCont").append("div").attr("class","playlist-link"),e=g.append("a").attr("href","https://last.fm/tag/"+l),f=(e.append("img").attr("class","playlist-link__img").attr("src","https://www.shareicon.net/data/32x32/2016/05/24/769923_logo_512x512.png").attr("style","background:none"),e.append("span").html("#"+l),r&&(g.append("span").attr("class","divider").html("/"),(e=g.append("a").attr("href",r.uri).attr("target","_self")).append("img").attr("class","playlist-link__img").attr("src","https://upload.wikimedia.org/wikipedia/commons/1/19/Spotify_logo_without_text.svg"),e.append("span").html(r.playlistName)),h[s.id]&&(o=function(){t(d+1,d+5,!1),ga("send",{hitType:"event",eventCategory:"Artist viewer",eventAction:"Next five",eventLabel:"test"})},i=function(){t(d-9,d-5,!1),ga("send",{hitType:"event",eventCategory:"Artist viewer",eventAction:"Previous five",eventLabel:"test"})},t=function(t,e,n){d3.selectAll(".scrobbled").remove();for(var a,r=t-1;r<=e-1;r++)h[s.id][r]?((a=d3.select("#details").append("div").attr({class:"scrobbled artist-div lowlight","data-artist":h[s.id][r].artist}).on("click",function(){d3.selectAll(".artist-div").classed({lowlight:!0,highlight:!1}),d3.select(this).classed({highlight:!0,lowlight:!1}),H(d3.select(this).attr("data-artist"))})).append("a").style("display","block").append("div").attr("class","image-div").style("background-image","url(https://lastfm.freetls.fastly.net/i/u/300x300/2a96cbd8b46e442fc41c2b86b821562f.png"),a.append("div").attr("class","play-count-div").append("p").html("<b>"+h[s.id][r].artist+"</b><br>"+h[s.id][r].playcount+" scrobbles").attr("class","details-p"),u++):r=e;t<d?d=5*Math.ceil((d-u)/5):d<e&&(d+=u),u=0,10<=d&&!n?d3.selectAll(".artist-control.left").classed("disabled",!1).on("click",function(){i()}):d3.selectAll(".artist-control.left").classed("disabled",!0).on("click",function(){d3.select(this).on("click",null)}),d>h[s.id].length-1?d3.selectAll(".artist-control.right").classed("disabled",!0).on("click",function(){d3.select(this).on("click",null)}):d3.selectAll(".artist-control.right").classed("disabled",!1).on("click",function(){o()})},u=d=0,d3.select("#details").append("div").html("<span>Your top artists tagged with </span>"+n+"<span> or </span>"+a+"<span>: </span>").attr("class","topartists-desc"),d3.select("#artistContainer").append("i").attr("class","fa artist-control right fa-angle-right").on("click",function(){o()}),d3.select("#artistContainer").append("i").attr("class","fa artist-control left disabled fa-angle-left").on("click",function(){i()}),t(1,5,!0)),d3.select("#recommendations").append("h4").html("You may like: ").attr("class","topartists-desc"),d3.select("#recommendations").append("div").attr("class","recLoadingDiv")),p=f.append("span").attr("id","rec-loading").html("Looking for artists tagged #"+c);f.append("img").attr({id:"rec-loading-img",src:"assets/img/loader_horizontal.gif"}).style({display:"inline-block",margin:"0 5px"}),f.append("span").attr("id","rec-loading-current"),api.getRecommendations(c,function(i){m&&m.id===s.id&&(p.html("Looking for artists tagged #"+l),api.getRecommendations(l,function(t){if(m&&m.id===s.id){p.html("Loading images for recommended artists");for(var e,n=i.concat(t),a={},r=0;r<n.length;r++)a[n[r].name]=n[r];for(e in n=new Array,a)n.push(a[e]);n.sort(function(t,e){return e.count<t.count?-1:e.count>t.count?1:0}),0===(n=function(t){for(var e=t.length-1;0<e;e--){var n=Math.floor(Math.random()*(e+1)),a=t[e];t[e]=t[n],t[n]=a}return t}(n=n.slice(0,20))).length&&(f.remove(),d3.select("#recommendations").append("p").html("We couldn't find any good "+c+" recommendations for you :-( "),d3.select("#recommendations").append("a").attr({href:"https://www.last.fm/tag/"+l,target:"_blank"}).html("Try searching last.fm yourself!"));for(var o=0;o<Math.min(n.length,5);o++){if(m.id!==s.id)return;api.getArtistInfo(n[o].name,function(t){f.remove();t[0].url;var e=t[0].image,n=t[0].name,t=d3.select("#recommendations").insert("div","#summaryText").attr("class","artist-div lowlight");t.append("a").style("display","block").append("div").attr("class","image-div").style("background-image","url('"+e+"')"),t.append("div").attr("class","recoArtistInfoDiv").append("p").html("<b>"+n+"</b>").attr("class","details-p"),t.on("click",function(){d3.selectAll(".artist-div").classed({lowlight:!0,highlight:!1}),d3.select(this).classed({highlight:!0,lowlight:!1}),H(n)})})}}}))})}function F(){api.cancelRecommendationRequests(),x.transition().style("opacity",0).duration(1e3),x.classed("hidden",!0),d3.selectAll("#countryCount, .on-map-view").classed("hidden",!1),d3.selectAll(".artist-div").remove("div"),d3.selectAll(".close-button").remove("button"),d3.selectAll(".details-h").remove("p"),d3.selectAll(".details-h4").remove("h4"),d3.selectAll(".recom-h4").remove("h4"),d3.selectAll(".artist-control").remove(),d3.selectAll(".topartists-desc").remove(),D.classed("hidden",!0),d3.select("#cnameCont").remove("h1"),d3.select("#cnameCont").remove("h5")}function H(l){var c,d=[],u=(d3.select("#summaryText").remove(),d3.select("#recommendations").append("div").attr("class","summaryText").attr("id","summaryText"));d3.select("#summaryText").append("span").html("Loading description of "+l),d3.select("#summaryText").append("img").attr({id:"sum-loading-img",src:"assets/img/loader_horizontal.gif"}).style({display:"inline-block",margin:"0 5px"}),api.getArtistInfo(l,function(t){var e=t[0].description.replace(/(\n)+/g,"<br />");c=t[0].tags;for(var n=0;n<15;n++)for(var a=0;a<c.length;a++)c[a]===USER_TAGS[n].tag&&d.push(USER_TAGS[n].tag);var r=(r=d.concat(c)).filter(function(t,e){return r.indexOf(t)==e}),t=(d3.select("#summaryText").html(""),.9*f.innerHeight-g.getElementById("artistContainer").offsetHeight);u.style("max-height",t+"px"),u.append("h4").html(l);for(var o=0;o<Math.min(r.length,6);o++)for(var i=u.append("div").attr("class","tagdiv").append("h4").html("#"+r[o]),s=0;s<d.length;s++)r[o]===d[s]&&i.classed("usertag",!0);u.append("p").html(e||"No description available - <a href='https://last.fm/music/"+l+"' target='_blank'>check out last.fm.</a>")})}function G(t,e){d3.selectAll(".country").classed("highlighted",!1),t?(d3.selectAll(".country").transition().style("opacity",function(){return+this.id==+e.id?1:.3}),d3.select(g.getElementById(""+e.id)).classed("highlighted",!0)):d3.selectAll(".country").transition().style("opacity",1)}function B(t){var e,n,a,r=b.bounds(t),o=(_(t),r[1][0]-r[0][0]),i=r[1][1]-r[0][1];if(o<80&&(o=80),t&&m!==t)switch(m=t,F(),U(t),G(!0,t),t.id){case 840:e=-(r[1][0]+r[0][0])/(a=3),n=-(r[1][1]+r[0][1])/1.7;break;case 250:a=7.012,e=-(r[1][0]+r[0][0])/1.8,n=-(r[1][1]+r[0][1])/3.4;break;case 528:a=9.0124,e=-(r[1][0]+r[0][0])/1.5,n=-(r[1][1]+r[0][1])/3.3;break;case 643:a=1.9,e=-(r[1][0]+r[0][0])/1.25,n=-(r[1][1]+r[0][1])/2;break;case 554:a=4,e=-(r[1][0]+r[0][0])/.9,n=-(r[1][1]+r[0][1])/1.8;break;case 36:a=3.3,e=-(r[1][0]+r[0][0])/1.8,n=-(r[1][1]+r[0][1])/2.1;break;default:a=.55/Math.max(o/l,i/s),e=-(r[1][0]+r[0][0])/2-l/a/4,n=-(r[1][1]+r[0][1])/2}else e=-l/2,n=-s/2-.08*s,a=1,F(),G(!1),m=null;t=p.translate();L([t[0]+e*a,t[1]+n*a],a,!0)}(map.nextTheme=e)(n),O(),C(),N(l,s),api.getCountriesData().then(function(t){return map.countryNames=v=t}),d3.json("assets/data/world-50m.json",function(t,e){e=topojson.feature(e,e.objects.countries).features;j(u=e,!0)}),map.move=L,map.putCountryCount=function(t){h=JSON.parse(JSON.stringify(t)),countryScore=0;var e=[];d3.keys(h).forEach(function(t){h[t][SESSION.name]&&(h[t]=h[t][SESSION.name],countryScore+=1,e.push(+t))}),u&&M(),f.countryScore=countryScore}}(window,document),{});!function(e,d){screenshot.render=function(){function n(t){s.font=t.font,s.fillText(t.string,r/2-s.measureText(t.string).width/2,t.y),t.lineWidth&&(s.lineWidth=t.lineWidth,s.strokeStyle=t.strokeStyle,s.strokeText(t.string,r/2-s.measureText(t.string).width/2,t.y))}var a=new Image,t=d3.select("#map-svg"),r=t.attr("width"),o=t.attr("height"),i=d.createElement("canvas"),s=i.getContext("2d"),l=e.getComputedStyle(d.body).backgroundColor,c=e.getComputedStyle(d.body).color;i.width=r,i.height=o,t.insert("rect","g").attr({id:"background-rect",width:"100%",height:"100%"}).style({fill:l}),d3.selectAll(".legend text, text.legend").style({"font-family":function(){return e.getComputedStyle(this).fontFamily},"font-size":function(){return e.getComputedStyle(this).fontSize},fill:c}),d3.selectAll(".legend rect").style({stroke:l}),canvg(i,(new XMLSerializer).serializeToString(t[0][0])),a.onload=function(){s.save(),s.globalAlpha=.6,s.fillStyle=l;var t=SESSION.total_artists+" artists from "+countryScore+" / 210 countries",e=SESSION.name+"'s musical world map";s.font="34px Patua One",s.fillRect(r/2-s.measureText(e).width/2-20,o-110,s.measureText(e).width+40,100),s.fillStyle=c,s.fillStyle=c,n({string:e,font:"34px Patua One",y:o-60}),n({string:t,font:"20px Didact Gothic",y:o-40}),s.restore(),s.drawImage(a,r-130,o-60,100,36),d3.select("#background-rect").remove(),d.getElementById("screenshot-img").src=i.toDataURL("image/png"),i.toDataURL("image/png");d.getElementsByClassName("screenshot-overlay")[0].style=""},a.src="assets/img/explrlogo.png"},screenshot.close=function(){d.getElementsByClassName("screenshot-overlay")[0].style="display:none;"}}(window,document);
//# sourceMappingURL=sourcemaps/all.min.js.map
